---
title: 虎书笔记——Chapter4：Ray Tracing
tags:
  - 图形学
  - 虎书
categories:
  - 图形学
date: 2022-04-21 10:01:45
---

# 光线追踪

计算机图形学的基本任务之一就是*渲染*三维物体：将放置在3D空间中的场景、模型或者一系列组合的几何物体，渲染成从一个特定视角下观察场景所得到的2D图片。这和几百年来建筑师和工程师所做的事情一样，即通过绘画来和其他人交流自己的设计。
从本质上来说，渲染是一个以一组物体作为输入，然后产生一个像素数组作为输出的过程。不管怎样，渲染考虑了每个物体是如何贡献到每个像素点的，它通常有两种组织形式。在*对象顺序渲染中（object-order rendering）*，我们将轮流考虑每个物体，然后找到所有被它影响的像素，并更新这些像素的值。在*图像顺序渲染（image-order rendering）*中，我们将轮流考虑每个像素，然后找到影响该像素的所有物体，并以此来计算该像素的值。你可以从循环嵌套的角度来理解二者的差异：在图像顺序渲染中，“逐像素”循环是在外层的；而在对象顺序渲染中，“逐物体”的循环是在外层的。
> 如果输出的图像是一个矢量图而不是光栅化图像，那么渲染其实是不用涉及到像素的，但是在本书中，我们所说的图像都是指光栅化图像。

图像顺序和对象顺序渲染方法能够计算出完全相同的图像，但是它们适用于计算不同类型的效果，而且它们有着截然不同的性能特征。在讨论完这两种方法之后，我们将在第8章来对比性地讨论它们的优势。但是一般来说，图像顺序渲染的工作方式更简单，也可以产生更加复杂的效果，但是通常（但并不总是）需要更多的计算时间来生成一个相同的图像。
> 在一个光线追踪渲染器中，是可以很容易计算场景中的阴影和反射的，但是这对于对象顺序渲染来说则是很困难的。
> **批注：**这里所说的对象顺序渲染的一个具体例子是前向渲染(Forward Rendering)，这是一个逐物体逐光源的渲染过程；图像顺序渲染的一个具体例子是延迟渲染(Deferred Rendering)，这是一个逐像素的过程，在光栅化阶段会将所需要的场景物体信息记录在G Bffer中，然后再进行光照计算。

![图4.1](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032304477.png)
> **图4.1**：光线在场景中进行“追踪”，第一个被光线击中的物体就是通过屏幕像素所看到的物体。在图中的例子中，三角形$T_2$就是通过像素所看到的物体。

光线追踪是一种用于渲染3D场景的图像顺序渲染算法，我们将第一个介绍它，这是因为它不需要开发其他的一些用于对象顺序渲染的数学工具也可以完成渲染任务。

## 4.1 基础的光线追踪算法

光线追踪一次只会计算一个像素，对于每个像素而言，其基本任务是找到图像上该像素位置所看到的物体。每个像素“看向”不同的方向，任何被该像素看到的物体都会和*观测光线*相交，一根观测光线是指从观测点沿着该像素所观察的方向发射出的一根射线。这个我们需要找到的特殊物体，是与观测光线相交的，且距离摄像机最近的物体，即它挡住了身后其他所有物体的视野。当我们找到了这个物体后，我们可以使用交点、表面法线和其他的一些信息（取决于所需的渲染类型）来进行着色计算，从而决定该像素的颜色。如图4.1所示，该光线和两个三角形相交，但是只有第一个击中的三角形$T_2$会被着色。
因此，光线追踪通常包括三个部分：

1. *光线生成*：根据相机的几何信息，计算每个像素的观测光线的起点和方向。
2. *光线求交*：找到最近的一个和观测光线相交的物体。
3. *着色*：根据光线求交的结果计算像素的颜色。

基本的光线追踪程序结构如下：

```txt
for each pixel do
  计算观测光线
  找到第一个和光线相交的物体，计算器表面法线n
  根据碰撞点、光线和表面法线n计算并设置像素颜色
```

本章介绍了光线生成、光线求交和着色的基本方法，这些方法足以实现一个简单的光线追踪demo。对于一个真正可用的系统，需要添加章节12中更加高效的光线求交技术；除此之外，我们将通过第10章中更加先进的着色技术和第13章中的额外渲染技术来看到光线追踪的真正潜力。

## 4.2透视

在计算机出现的几百年前，艺术家们研究了如何使用2D绘图或者绘画来表现3D物体和场景的问题，照片也是通过2D图像来表现3D场景。虽然有很多非常规的手段来生成图像，如立体绘图、鱼眼透镜（图4.2）、外置相机等，但是对于艺术、摄影以及计算机图形学而言，它们的标准方法都是*线性透视(linear perspective)*，它将3D物体投影到一个*图像平面*上，同时保证场景中的直线被投影到平面上之后依然是直线。

![图4.2](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032304765.png)
> **图4.2**：通过一个鱼眼透镜生成的图像并不是线性透视的。该照片由Philip Greenspun提供。

最简单的投影类型是*平行投影（parallel projection）*，将3D点沿着投影方向进行移动，直到它落在图像平面上，通过这种方法将一个3D点映射成2D点（图4.3-图4.4）。用这种方法生成的视图取决于投影方向和图像平面的选择，若图像平面和视线方向相垂直，则这种投影叫做*正交投影（orthographic）*，反之叫做斜轴投影（oblique）。

![图4.3](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032305267.png)
> **图4.3**：当投影线相互平行且垂直于图像平面时，形成的视图叫做正交投影。

![图4.4](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032308076.png)
> **图4.4**：图像平面和投影方向成一定角度的平行投影叫做斜轴投影（如右图所示）。在透视投影中，所有的投影线都会相交于观测点，而不是相互平行（如左图所示）。图示中的透视投影并不是斜轴投影，这是因为穿过图像平面中心的投影线依然垂直于图像平面。

平行投影常常用于机械和建筑绘图，因为它保持了平行线相互平行的特点，且保持了和图像平面平行的平面物体的大小和形状。
