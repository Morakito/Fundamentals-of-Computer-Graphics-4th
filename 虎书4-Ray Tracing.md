---
title: 虎书笔记——Chapter4：Ray Tracing
tags:
  - 图形学
  - 虎书
categories:
  - 图形学
date: 2022-04-21 10:01:45
---

# 光线追踪

计算机图形学的基本任务之一就是*渲染*三维物体：将放置在3D空间中的场景、模型或者一系列组合的几何物体，渲染成从一个特定视角下观察场景所得到的2D图片。这和几百年来建筑师和工程师所做的事情一样，即通过绘画来和其他人交流自己的设计。
从本质上来说，渲染是一个以一组物体作为输入，然后产生一个像素数组作为输出的过程。不管怎样，渲染考虑了每个物体是如何贡献到每个像素点的，它通常有两种组织形式。在*对象顺序渲染中（object-order rendering）*，我们将轮流考虑每个物体，然后找到所有被它影响的像素，并更新这些像素的值。在*图像顺序渲染（image-order rendering）*中，我们将轮流考虑每个像素，然后找到影响该像素的所有物体，并以此来计算该像素的值。你可以从循环嵌套的角度来理解二者的差异：在图像顺序渲染中，“逐像素”循环是在外层的；而在对象顺序渲染中，“逐物体”的循环是在外层的。
> 如果输出的图像是一个矢量图而不是光栅化图像，那么渲染其实是不用涉及到像素的，但是在本书中，我们所说的图像都是指光栅化图像。

图像顺序和对象顺序渲染方法能够计算出完全相同的图像，但是它们适用于计算不同类型的效果，而且它们有着截然不同的性能特征。在讨论完这两种方法之后，我们将在第8章来对比性地讨论它们的优势。但是一般来说，图像顺序渲染的工作方式更简单，也可以产生更加复杂的效果，但是通常（但并不总是）需要更多的计算时间来生成一个相同的图像。
> 在一个光线追踪渲染器中，是可以很容易计算场景中的阴影和反射的，但是这对于对象顺序渲染来说则是很困难的。
> **批注：**这里所说的对象顺序渲染的一个具体例子是前向渲染(Forward Rendering)，这是一个逐物体逐光源的渲染过程；图像顺序渲染的一个具体例子是延迟渲染(Deferred Rendering)，这是一个逐像素的过程，在光栅化阶段会将所需要的场景物体信息记录在G Bffer中，然后再进行光照计算。

![图4.1](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032304477.png)
> **图4.1**：光线在场景中进行“追踪”，第一个被光线击中的物体就是通过屏幕像素所看到的物体。在图中的例子中，三角形$T_2$就是通过像素所看到的物体。

光线追踪是一种用于渲染3D场景的图像顺序渲染算法，我们将第一个介绍它，这是因为它不需要开发其他的一些用于对象顺序渲染的数学工具也可以完成渲染任务。

## 4.1 基础的光线追踪算法

光线追踪一次只会计算一个像素，对于每个像素而言，其基本任务是找到图像上该像素位置所看到的物体。每个像素“看向”不同的方向，任何被该像素看到的物体都会和*观测光线*相交，一根观测光线是指从观测点沿着该像素所观察的方向发射出的一根射线。这个我们需要找到的特殊物体，是与观测光线相交的，且距离摄像机最近的物体，即它挡住了身后其他所有物体的视野。当我们找到了这个物体后，我们可以使用交点、表面法线和其他的一些信息（取决于所需的渲染类型）来进行着色计算，从而决定该像素的颜色。如图4.1所示，该光线和两个三角形相交，但是只有第一个击中的三角形$T_2$会被着色。
因此，光线追踪通常包括三个部分：

1. *光线生成*：根据相机的几何信息，计算每个像素的观测光线的起点和方向。
2. *光线求交*：找到最近的一个和观测光线相交的物体。
3. *着色*：根据光线求交的结果计算像素的颜色。

基本的光线追踪程序结构如下：

```txt
for each pixel do
  计算观测光线
  找到第一个和光线相交的物体，计算器表面法线n
  根据碰撞点、光线和表面法线n计算并设置像素颜色
```

本章介绍了光线生成、光线求交和着色的基本方法，这些方法足以实现一个简单的光线追踪demo。对于一个真正可用的系统，需要添加章节12中更加高效的光线求交技术；除此之外，我们将通过第10章中更加先进的着色技术和第13章中的额外渲染技术来看到光线追踪的真正潜力。

## 4.2透视

在计算机出现的几百年前，艺术家们研究了如何使用2D绘图或者绘画来表现3D物体和场景的问题，照片也是通过2D图像来表现3D场景。虽然有很多非常规的手段来生成图像，如立体绘图、鱼眼透镜（图4.2）、外置相机等，但是对于艺术、摄影以及计算机图形学而言，它们的标准方法都是*线性透视(linear perspective)*，它将3D物体投影到一个*图像平面*上，同时保证场景中的直线被投影到平面上之后依然是直线。

![图4.2](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032304765.png)
> **图4.2**：通过一个鱼眼透镜生成的图像并不是线性透视的。该照片由Philip Greenspun提供。

最简单的投影类型是*平行投影（parallel projection）*，将3D点沿着投影方向进行移动，直到它落在图像平面上，通过这种方法将一个3D点映射成2D点（图4.3-图4.4）。用这种方法生成的视图取决于投影方向和图像平面的选择，若图像平面和视线方向相垂直，则这种投影叫做*正交投影（orthographic）*，反之叫做斜轴投影（oblique）。

![图4.3](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032305267.png)
> **图4.3**：当投影线相互平行且垂直于图像平面时，形成的视图叫做正交投影。

![图4.4](https://morakito-blog.oss-cn-beijing.aliyuncs.com/Fundamentals-of-Computer-Graphics-4th/Chapter-4/202206032308076.png)
> **图4.4**：图像平面和投影方向成一定角度的平行投影叫做斜轴投影（如右图所示）。在透视投影中，所有的投影线都会相交于观测点，而不是相互平行（如左图所示）。图示中的透视投影并不是斜轴投影，这是因为穿过图像平面中心的投影线依然垂直于图像平面。

平行投影常常用于机械和建筑绘图，因为它保持了平行线相互平行的特点，且保持了和图像平面平行的平面物体的大小和形状。
> 有些书籍将平行于坐标轴的投影也称为“正交“。

平行投影的优势同时也是他的缺点。在我们的日常生活中（在照片中更加常见），距离越远的物体看起来越小，因此随着平行线向着远处延伸，它们显得不再平行。这是因为眼睛和相机并不是从一个单一的方向来收集光线的，它们收集了穿过一个特定观测点的所有光线。这一点从文艺复兴以来被艺术家们所认可，我们可以使用*透视投影（prespective projection）*来创建一个看起来很自然的视角：我们只是沿着穿过某个点（即视角点）的直线进行投影，而不是沿着平线进行投影（如图4.4），在这种情况下，远离视角点的物体在被投影的时候回自然地变小。透视投影的视野取决于观测点和图像平面的选择(而不是投影方向)，和平行投影类似，在透视投影中也有斜轴和非斜轴之分，其中的区别在于投影方向是否垂直于图像平面。

> **图4.5：**在三点透视中，艺术家用“消失点”来标记平行线的相交点。平行的水平线会相交于地平线上的某一点，每一组平行线会有其自己的消失点。如果我们在实现透视投影时遵循正确的几何原则，这些规则会自动显现。

你可能学习过有关*三点透视原则*的艺术概念，这是一个用于手工构建透视视野的系统（如图4.5）。关于透视的一个令人惊讶的事实是，透视图的所有的规则会被自动遵循如果我们遵循以下的数学原则：物体被直接投影向眼睛，并且在当遇到眼睛前的投影的时候会被绘制。

## 4.3 计算观测射线

在之前的章节中，用于生成光线的基础工具是观测点（对于平行投影而言则是观测方向）和图像平面。有很多方式可以计算出相机的几何表示，在本小节中我们将介绍一种基于正交基底的方法，它支持垂直、斜轴以及正交视角。
为了生成光线，我们首先需要一种对于光线的数学表示，一根光线事实上是一个原点和一个传播方向，3D参数化直线是一种理想的表达方式。如在章节2.5.7中所讨论的，从眼睛$\mathbf{e}$出发，到达图像平面上一点$\mathbf{s}$的3D参数化直线可以写成如下形式L：
$$\mathbf{p}(t) = \mathbf{e} + t(\mathbf{s - e})$$
这可以被解释成：我们从点$\mathbf{e}$出发，沿着向量$\mathbf{(s - e)}$前进$t$个单位到达点$\mathbf{p}$。因此对于给定的$t$，我们可以决定一点$\mathbf{p}$。其中$\mathbf{e}$是光线的原点，$\mathbf{(s - e)}$是光线的方向。

> **图4.6：**从眼睛出发，到图像平面上一点的光线。

注意到$\mathbf{p}(0) = \mathbf{e}$，且$\mathbf{p}(1) = \mathbf{s}$。更普遍的是，若$0 < t_1 < t_2$，则$\mathbf{p}(t_1)$会比$\mathbf{t_2}$更靠近眼睛；同时，若$t < 0$则说明$\mathbf{p}(t)$在眼睛“背后”。当我们寻找被光线击中的最近物体时（在眼睛前面的物体），这些事实将会很有用。

